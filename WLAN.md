广域网基本概念
当主机之间的距离较远时，例如，相隔几十或几百公里，甚至几千公里，局域网显然就无法完成主机之间的通信任务。这里就需要另一种结构的网络，即广域网



广域网与互联网区别
互联网尽管覆盖范围很广，但它不是广域网，它是由多个不同网络构成的，“互联”是其最主要的特征。
广域网是单个网络，它使用结点交换机连接各主机而不是是路由器连接各网络。
结点交换机在单个网络中转发分组，而路由器在多个网络构成的互联网中转发分组。
连接在一个广域网（或一个局域网）上的主机在该网内进行通信时，只需要使用其网络的物理地址即可。

网络层提供的服务
服务与通信子网无关
应该提供面向连接的服务还是无连接服务
   面向连接服务（虚电路服务）：传统电信的观点，通信子网应该提供可靠的、面向连接的服务，而将复杂的功能放在网络层（通信子网）。
  无连接服务（数据报服务）：Internet的观点，通信子网无论怎么设计均不可靠，网络层只需提供无连接服务，而将复杂的功能放在传输层。
  二者本质区别：复杂的差错控制和流量控制放在何处（网络层/传输层）的总是。



数据报服务示意图

数据报服务特点
随时接受主机发送的分组（即数据报）
为每个分组独立地选择路由
尽最大努力地将分组交付给目的主机
对源主机没有任何承诺
不能保证所传送的分组不丢失
不能保证按源主机发送分组的先后顺序以及在时限内必须将分组交付给目的主机
当网络发生拥塞时，结点可根据情况丢弃分组
数据报服务实际上是一种“尽力而为”（Best Effort)的服务


虚电脑示意图







### 数据报服务和虚电路服务对比 
|对比内容|虚电路服务|数据服服务|
|--|--|--|--|
|思路 |可靠通信应当由网络来保证| 可靠通信应当由用户主机来保证|
|连接建立 |必须有 |不要|
|目的站地址 |仅在连接建立阶段使用，每个分组使用短的虚电路号 |每个分组都有目的站的全地址|
|分组的转发 |属于同一条虚电路的分组均按照同一路由进行转发| 每个分组独立选择路由进行转发|
|当结点出故障时| 所有通过出故障的结点的虚电路均不能工作 |故障结点可能丢失分组，一些路由可能会发生变化|
|分组的顺序 |总是按发送顺序到达目的站 |到达目的站时不一定按发送顺序|
|端到端的差错处理和流量控制 |可以由分组交换网负责也可以 |由用户主机负责 由用户主机负责|


### 路由算法
- 路由算法是网络层软件的一部分
  - 子网提供数据报服务，每个包都要做路由选择
  - 子网提供虚电路服务，只需要建立连接时做一次路由选择

- 路由算法应具有的特性
  - 正确性(correctness)：即能正确而迅速地将分组从源节点传送到目的节点。
  - 简单性(simplicity)：实现简单，相应的软件开销少。
  - 健壮性(robustness:鲁棒性,网络出现有意外事件的时候，路由算法能不能适应)：当网络拓扑发生变化（如某节点发生故障），或者通信量发生变化（如网络拥塞）时，能及时调整并选择新的路由。
  - 稳定性(stability，网络正常使用的时候，第一天还正常，和二天出了一点小总是，半个月后几乎不能正常转发数据了。比如转发几个分组时正常，当转发几百个分组时就出问题了)：算法应是是可靠的，即不管运行多久，保持正确性而不发生振荡。
  - 快速收敛：收敛是在最佳路径的判断上，所有路由器达到一致的过程。。当某个网络事件引起路由可用或不可用时，路由器就发生更新信息。路由更新信息遍及整个网络，引发重新计算最佳路径，最终达到所有路由器一致公认的最佳路径。收敛慢的路由算法会造成路径循环或网络中断。
  - 公平性(fairness)和最优性(optimality)：要保证每个节点都有机会传送信息，又要保证路由选择最佳。

### 路由算法分类
- 按转发方式和数据副本数量划分
  - 全路由算法：如洪泛，按照所有路径广播转发
  - 多路路由算法：如选择洪泛算法，向所有接近目的节点的路径转发
  - 单路路由算法：如距离 矢量算法，向目的节点沿着唯一的路转发
- 按健壮性和简单性划分
  - 非自适应算法（静态路由算法）：不能根据网络流量和拓扑结构的变化更新路由表，使用静态路由表。
      - 特点：简单、开销少、灵活性差。
      - 典型算法：基于流量的路由算法等。
  - 自适应算法（动态路由算法）：可根据网络流量和拓扑结构的变化更新路由表。
      - 特点：开销磊； 健壮性和灵活性好。
      - 典型算法：距离向量路由算法，链路状态路由算法等； 


### 自适应路由算法工作过程
- 测量（获取）有关路由选择的网络度量参数
  -  如何测量？选取哪些网络参数？
- 将路由信息传送到适当的网络节点
  - 传送给谁？如何传送？传送什么信息？
- 计算和更新路由表
  - 更新路由表的算法
- 根据新路由表执行分组的转发


### 路由算法设计最优化原则
- 最优化原则（optimality principle)
   - 如果路由器J在路由器I到K的最优路由上，那么从J到K的最优路由一定落在同一路由上。
- 汇集树（sink tree)
  - 从所有的源结点到一个给定的目的结点的最优路由的集合形成了一个以目的结点为根的树，称为汇集树； 
  - 路由算法目的的是找出并使用汇集树。



### 最短路径路由
- 基本思想
   - 构建子网的拓扑网，图中的每个结点代表一个路由器，每条弧代表一条通信线路。为了选择两个路由器间的路由，算法需要在图中找出结点间的最短路径。
- 网络度量参数
  - 结点数量
  - 地理距离
  - 传输延迟
  - 距离、信道带宽等参数的加权函数


### 分层路由
- 网络规模增长带来的问题
  - 路由器中的路由表增大
  - 路由器为选择路由而占用的内存，CPU时间和网络带宽增大。
- 分层路由
  - 分而治之的思想
  - 根据需要，将路由器分成区域（regions)、聚类(clusters)、区（zones)和组(groups)....
  - Fig. 6-6,路由表由17项减为7项。
- 分层路由带来的问题
  - 路由表中路由不一定是最优路由。

![image.png](https://upload-images.jianshu.io/upload_images/5177180-8c2a496014d5ed12.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
分层路由也有瑕疵，如到达5C，走的路由是1C-3B-4A-5A-5B-5C.这不是最优的选择，最优的选择1B-2A-2C-2D-5C。但是从性能上来是确得到了极大的改善。

### 距离向量路由算法思想
- 每个路由器维护一张路由表，表中给出了到每个目的地的已知最佳距离和线路，并通过与相邻路由器距离信息来更新表
- 每隔一段时间，路由器向所有邻居结点发送它到每个目的结点的距离表，同时它也接收每个邻居结点发来的距离表
- 邻居结点X发来的表中，X到路由器i的距离为Xi，本路由器到X的距离为m，则路由器经过X到i的距离为Xi+m.根据不同邻居发来的信息，计算Xi+m，并取最小值，更新本路由器的路由表


### 拥塞控制
- 拥塞：网络上有太多的包时，性能会急剧下降，这种现象称为拥塞
- 拥塞产生原因：对资源需求的总和>可用资源
- 解决办法：
  - 解决需求和能力的矛盾
  - “头疼医头、脚痛医脚"解决方案只能转移 影响性能的瓶颈
  - 需要全面考虑各个因素





### 拥塞发现
- 拥塞度量
  - 缺乏缓冲区造成的丢包率上升
  - 平均队列长度变长
  - 超时重传的包的数目增大
  - 平均包延迟增大
  - 包延迟变化增大
- 拥塞监视点
  - 源节点
  - 中间路由器

### 拥塞控制与流量控制区别
- 拥塞控制：需要确保通信子网能够承载用户提交的通信量，是一个全局性问题，涉及主机、路由器等很多因素； 
- 流量控制：与点到点通信量有关，主要解决快速发送方与慢速接收方的问题，是局部问题，一般都是基于反馈进行控制的。

### 拥塞控制方法
- 根据控制论，拥塞控制方法分为两类
  - 开环控制
      - 通过好的设计来解决总是，避免拥塞发生
      - 拥塞控制时，不考虑网络当前状态
  - 闭环控制
     - 基于反馈机制
     - 工作过程
          - 监控系统，发现何时何地发生拥塞
          - 把发生拥塞的消息传给能采取动作的站点
          - 调整系统操作，解决问题
- 拥塞控制的实现位置
  - 链路算法
  - 源算法


### 漏桶算法
- 基本思想
  - 造成拥塞的主要原因是网络流量通常是突发性的； 
  - 强迫包以一种可预测的速率发送；
  - 在ATM网中广泛使用； 
- 漏桶算法
  - 将用户发出的不平滑的数据包流转变成网络中平滑的数据包流； 
  - 可用于固定包长的协议，如ATM； 也可用于可变包长的协议，如IP，使用字节计数； 
  - 无论负载突发性如何，漏桶算法强迫输出按平均速率进行，不灵活； 

### 令牌桶算法
- 令牌桶算法
   - 漏桶算法不够灵活，因此加入令牌机制；
  - 基本思想：漏桶存放令牌，每⧊T秒产生一个令牌，令牌累积到超过漏桶上界时就不再增加，包传输之前必须获得一个令牌，传输之后删除该令牌； 
- 漏桶算法与令牌算法的区别
   - 流量整形策略不同：漏桶算法不允许空闲主机积累发送权，以便以后发送大的突发数据； 令牌桶算法允许，最大为桶的大小。
   - 漏桶中存放的是数据包，桶满了丢弃数据包； 令牌桶中存放的是令牌，桶满了丢弃令牌，不丢弃数据包；

### 网络互联
- 互联网：两个或多个网络构成互联网
- 因特网：最大的互联网
- 多种不同网络（协议）存在的原因：
   - 历史原因：不同公司的网络产品大量使用； 
   - 价格原因：网络产品价格低，更多的人有权决定使用何种网络； 
   - 技术原因；不同网络采用不同技术、不同硬件、不同协议； 

### 网络互联的分类
- 广域网与广域网的互连
  - 如两个X.25网络 的互连
- 广域网与局域网的互连
  - 如Ethernet和ATM的互连
- 局域网和局域网的互连
  - 如无线局域网与Ehernet的互连
- 两个局域网通过广域网的互连
  - 如两个Ethernet通过帧中继网互连

### 网络互联设备
- 中继器
  - 物理层设备，在电缆段之间拷贝比特；
  - 对弱信号进行广大或再生，以便延长传输距离； 
- 网络
  - 数据链路层设备，在局域网之间存储转发帧； 
  - 网络可以 改变帧格式
- 路由器
  - 网络层设备，在网络之间存储转发包
  - 必要时，做网络层协议转换
- 网关
  - 传输网关
  - 应用网关

### 网络互联设备工作层次含义
- 网络互联设备需要加载的最高层协议
- 互联网络的该层及以下各层协议可以相同也可以不同，但是该层以上层协议必须相同
- 网络互联设备按照该层地址进行数据转发

### 路由器与网桥
- 相同点：可以实现LAN互联，与网桥实现LAN互联区别；
- 不同点：
   - 路由器互联的LAN网络层协议可不同； 
   - 路由器避免广播风暴； 
   - 路由器转发效率错于网桥转民数据的效率； 
   - 路由器可完成LAN与WAN的互联； 


### 广域网实例
- X.25网就是X.25分组交换网，它是在二十多年前根据CCITT(即现在ITU-T)的X.25建议书实现的计算机网络。
- X.25只是一个对公用分组交换网接口的规约。X.25所讨论的都是以面向连接的虚电路服务为基础。



### X.25层次关系
- 用户数据在X.25的分组层（相当于网络层）加上X.25的首部控制信息后，就组装成为X.25分组。
- 在数据链路层使用的是HDLC的一个子集———平衡型链路接入规程LAPB。
- 在分组DTE与DCE之间可建立多条逻辑信道（0~4095号），使一个DTE同时和网上其他多个DTE建立虚电路并进行通信
- X.25还规定了在经常需要进行通信的两个DTE之间可以建立永久虚电路。这些虚电路号以及分组序号等控制信息都写在X.25分组的首部中。



### X.25网与IP网
- 基于IP协议的因特网是无连接的，只提供尽最大努力交付的数据报服务，无服务质量可言
- X.25网是面向连接的，能够提供可靠交付的虚电路服务，能保证服务质量
- 正因为X.25网能保证服务质量，在二十多年前它曾经是颇受欢迎的一种计算机网络 。

### X.25的衰亡
- 到了20世纪90年代，通信技术进步太大
   - 通信主干线路已大量使用光纤技术，数据传输质量大大提高使得误码率降低好几个数量级
   - X.25十分复杂的数据链路层协议和分组层协议已成为多余的
- PC机的价格急剧下降使得无硬盘的哑终端退出了通信市场。这正好符合因特网当初的设计思想：网络应尽量简单而智能应尽可能放在网络以外的用户端

### 帧中继FR
- 在20世纪80年代后期，许多应用都迫切要求增加分组交换服务的速率。
- 帧中继FR(Frame Relay)就是一种支持高速交换的网络体系结构。
- 帧中继在许多方面非常类似于X.25，被称为第二代X.25（快速X.25）
- 今天的数字光纤网比早期的电话网具有更低的误码率，如果减少结点对分组的处理时间，则各分组通过网络的时延亦可减少，提升结点对分组的处理能力。

### 帧中继减少结点处理时间 
- 帧中继不使用差错恢复和流量控制机制
- 当帧中继交换机收到一个帧的首部时，中要一查出帧的目的地址就立即进行转发
- 因此在帧中继网络中，一个帧的处理时间 比X.25网纸减少一个数量级。相应地，帧中继网络的吞吐量要比X.25网络的提高一个数量级以上。

### 帧中继对差错的处理
- 当检测到有误码时，结点要立即中止这次传输
- 如果需要重传出错的帧，则由源站使用高层协议（而不是帧中继协议）请求重传该帧。
- 仅当帧中继网络本身的误码率非常低时，帧中继技术才是可行的

### 帧中继使用虚电路
- 帧中继的逻辑连接的复用和交换都在第二层处理，而不是像X.25在第三层处理。
- 帧中继网络身上提供面向连接的虚电路服务。虚电路一般分为交换虚电路SVC和永久虚电路PVC两种。
- 帧中继网络通常为相隔较远的一些局域网提供链路层的永久虚电路服务，它的好处是在通信时可省去建立连接的过程。
- 如果有N个路由器需要用帧中继网络进行连接，那么就一共需要有N(N-1)/2条永久虚电路


### 异步传递方式ATM
- 人们曾经设想过“未来最理想的”一种网络应当是宽带综合业务数字网B-ISDN.
- B-ISDN采用新的ATM交换技术。这种技术结合了电路交换和分组交换的优点
- 虽然在B-ISDN并没有成功，但ATM技术还是获得了相当广泛的使用，并在因特网的发展中起到了重要作用。

### ATM概念
- 此ATM（Asynchronous Transfer Mode）非彼ATM(Automatic Telling Machine)
- ATM是建立在电路交换和分组交换的基础上的一种面向连接的快速分组交换技术；
- ATM采用定长分组作为传输和交换的电位，这种定长分组叫做信元（cell)

### "异步“的含义
- 当用户的ATM信元需要传送时，就可插入到SDH的一个帧中。
- SDH传送的同步比特流被划分为一个个固定时间长度的帧（请注意，这是时分复用的时间帧，而不是数据链路层的帧）。
- 每一个用户发送的ATM信元在每一个时分利用帧中的相对位置并不是固定不变的。

### ATM优点
- 选择固定长度的短信元作为信息传输的单位，有得于宽带高速交换。信元长度为53字节，能支持不同速率的各种业务。
- 所有信息以面向连接的方式传送，保持了电路交换在保证实时性和服务质量方面的优点。
- ATM使用光纤信道传输
   - 光纤信道的误码率极低，且容量很大，因此在ATM网内不必在数据链路层进行差错控制和流量控制（放在高层处理），提高了信元在网络中传送速率。

### ATM缺点
- ATM信元首部的开销太大
   - 5字节的信元首部，在53字节的信元中所占的比例相当大
- ATM的技术复杂且价格较高
- ATM能够直接支持的应用不多
- 千兆与10千兆以太网的问世，进一步削弱了ATM因特网高速主干领域的竞争能力。

### ATM网络中网络元素
- ATM端点（又称为ATM端系统）通过点到点链路与ATM交换机相连
- ATM交换机是一个快速分组交换机（交换容量高达数百Gb/s），其主要构件是:
     - 交换结构（switching fabric）
     - 若干个高速输入端口和输出端口
     - 必要的缓存



### ATM逻辑连接机制
- 在ATM中使用的虚电路是一种逻辑连接  
- 虚电路是ATM网络中基本交换单元  
- 两个端用户要进行通信，首先必须建立虚通路连接，然后才能在这个端到端连接上以固定信元长度和可变速率进行全双工的通信。数据传送完毕后再释放连接  




![广域网互联](https://upload-images.jianshu.io/upload_images/5177180-18da34a492217edc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


![拥塞控制作用](https://upload-images.jianshu.io/upload_images/5177180-bde40e4d5bd5939f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


![image.png](https://upload-images.jianshu.io/upload_images/5177180-eb630ced5a3aaa0c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![image.png](https://upload-images.jianshu.io/upload_images/5177180-dab724afa16eb1c0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)



### 注意事项
- 一个个网络，也叫网段
- 纯粹几个局域网相连构成的网也叫互联网，互联网相连的网络不一定就是广域网
- 路由器不是直接接主机的，你说路由器不是也是外接，也有一些物理接口吗？也有以太口，甚至还有串口啊 。那么路由器的确 提供了这个外设接口。你说广域网的节点交换机甚至我们的主机不也提供有类似这些物理接口吗。但是路由器这些物理接口用于连接 的都是我们有时都叫网段但首先这个网的段的概念和小型的网络是一回事的。路由器连接的都是一个个网络。
- 局域网和广域网的内部通信都需要物理地址，比如局域网通信用MAC地址，广域网通信使用ATM网络ATM地址。
- 以太网主机能不能和ATM主机直接通信？ 以太网主机知道ATM主机的ATM地址。这个绝对通不起来。 跨网传输必须作用路由器或者说使用网间连接设备。
- 在网络层提供的面向连接服务叫虚电路服务，网络层提供的无连接服务叫数据报服务
- 面向连接服务和无连接服务没有层次关系。
- 面向连接服务可控制性强，比较容易实现差错控制和流量控制。
- 路由算法特性能不能同时出现，一些特性是相互矛盾的，如果路由算法简单性的，对健壮性和稳定性就不能保证了，所以最后就一个全局的总体和最优性，只能是一个折中各个指标的一个权衡最终的一个比较优化的指标
- 按转发方式和数据副本数量划分：首先针对的都是一个单播通信当中，就是源端的数据明确地发给一个特定的目的方，是这种情况下的路由过程。
- 在通信过程中，通信双方以分组为单位、使用存储-转发机制实现数据交互的通信方式，**被称为分组交换（PS:packet switching）**
- 全路路由算法和单路路由算法有什么本质区别？从优势来讲的话，我们说输出数据的副本或者说对于网络资源的消耗明显是单路路由算法小，全路路由算法大。全路路由的优势是从入口接收了分组以后要不要做查表。原因查表的目的是为了 唯一的确定是往那个输出口去送，现在不关心向那个输出口送， 我只往所有的输出口送，不加选择的所有 输出口 全部送走， 要不要查表，不要查表。第一当然省去了本身查表过程，第二还用不用构建那个路由表，我都不用查表，就不需要路由表了。这不需要什么路由控制功能 ，仅仅是一个转发功能 。
- 选择路由算法，比全路路由强一些是原因，不会全部所有节点都发送数据，而是选择性的发送，向着靠近目的主机的方向发送数据。相对全路路由算法有很大的改进正，但是依然有庞大的副本或者有大量的存储数据。所以这二种路由算法在现实当中我们真正的 用户业务分组数据的传输几乎都不使用。原因这种使用的话，用户发一份数据要消耗多少网络资源，就会消耗大量的网络资源，这是不可取的。就相当于我们节省了一点节点控制资源来消耗大量的网络带宽传输资源。实现当中我们主要使用单路路由算法使用的比较广泛，像距离矢量路由算法、链路状态路由算法，这些路由算法都能生成路由表的。我们转发分组的时候基于分组的目标IP地址然后查表确定唯一的出口。
- 在动态路由中可以加静态路由，可以联合使用。在这二条路由都存在的话，静态路由的优先级别要高（原因网管人可能根据一些特定的需求设定的，这是满足他的紧迫的或者说最使用的某一种需求）。网络变化有二种，一是网站拓扑的变化，二是网流量的变化 。

